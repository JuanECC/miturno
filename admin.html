<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dirección Médica - Panel de Estadísticas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./rsc/css_admin.csss">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top mb-4 shadow" id="mainNav">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#">
            <i class="fas fa-hospital-alt"></i> CENTRO DE MANDO - DIRECCIÓN MÉDICA
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuAdmin">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="menuAdmin">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="recepcion.html">
                        <i class="fas fa-door-open"></i> Recepción
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="pantalla.html">
                        <i class="fas fa-desktop"></i> Pantalla de turnos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="doctor.html">
                        <i class="fas fa-user-md"></i> Doctor
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="admin.html">
                        <i class="fas fa-chart-line"></i> Estadísticas
                    </a>
                </li>
            </ul>

            <button id="darkModeBtn" class="btn btn-outline-light ms-3">
                <i class="fas fa-moon"></i> Modo Oscuro
            </button>
        </div>
    </div>
</nav>

<div class="container mt-5 pt-5">
    <!-- CABECERA -->
    <div class="page-header fade-in">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="page-title">
                    <i class="fas fa-chart-bar text-primary me-2"></i>Panel de Estadísticas
                </h1>
                <p class="page-subtitle">
                    Datos en tiempo real del flujo de pacientes y saturación del servicio
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div id="tiempo-actual" class="card border-0 bg-light p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div id="fecha" class="fw-bold"></div>
                            <div id="hora" class="text-muted"></div>
                        </div>
                        <i class="fas fa-clock fa-2x text-primary"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TARJETAS DE ESTADÍSTICAS -->
    <div class="row mb-4 fade-in">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white shadow">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1">Total Pacientes</h6>
                        <h2 class="mb-0 fw-bold" id="total-pacientes">0</h2>
                        <small class="opacity-75" id="pacientes-detalle">En espera: 0</small>
                    </div>
                    <div class="icon-box">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-danger text-white shadow">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1">Críticos (N1 y N2)</h6>
                        <h2 class="mb-0 fw-bold" id="total-criticos">0</h2>
                        <small class="opacity-75" id="criticos-detalle">Requieren atención inmediata</small>
                    </div>
                    <div class="icon-box">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white shadow">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1">Atendidos Hoy</h6>
                        <h2 class="mb-0 fw-bold" id="total-atendidos">0</h2>
                        <small class="opacity-75" id="atendidos-detalle">Desde inicio de jornada</small>
                    </div>
                    <div class="icon-box">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-info text-white shadow">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-uppercase mb-1">Saturación</h6>
                        <h2 class="mb-0 fw-bold" id="saturacion">0%</h2>
                        <div id="saturacion-badge" class="saturacion-badge saturacion-bajo mt-1">Baja</div>
                    </div>
                    <div class="icon-box">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GRÁFICAS -->
    <div class="row fade-in">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header">
                    <i class="fas fa-chart-bar"></i> Distribución por Nivel de Triaje (Actual)
                </div>
                <div class="card-body">
                    <canvas id="chartNiveles" height="250"></canvas>
                </div>
                <div class="card-footer bg-transparent">
                    <div class="row text-center">
                        <div class="col">
                            <span class="badge bg-danger p-2">N1: Resucitación</span>
                        </div>
                        <div class="col">
                            <span class="badge bg-warning p-2">N2: Emergencia</span>
                        </div>
                        <div class="col">
                            <span class="badge bg-info p-2">N3: Urgencia</span>
                        </div>
                        <div class="col">
                            <span class="badge bg-success p-2">N4: Menor</span>
                        </div>
                        <div class="col">
                            <span class="badge bg-primary p-2">N5: No Urgente</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header">
                    <i class="fas fa-stethoscope"></i> Demanda por Especialidad
                </div>
                <div class="card-body">
                    <canvas id="chartEspecialidad" height="250"></canvas>
                </div>
                <div class="card-footer bg-transparent text-center">
                    <small class="text-muted">Distribución actual de pacientes en espera</small>
                </div>
            </div>
        </div>
    </div>

    <!-- TABLA DE RESUMEN -->
    <div class="row mt-4 fade-in">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <i class="fas fa-table"></i> Resumen Detallado
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Nivel</th>
                                    <th>Prioridad</th>
                                    <th>Pacientes</th>
                                    <th>Tiempo Promedio</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-resumen">
                                <!-- Se llenará dinámicamente -->
                                <tr>
                                    <td colspan="5" class="text-center">Cargando datos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { db } from './firebase-config.js';
    import { collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Variables para las gráficas
    let chartNivelesInstancia = null;
    let chartEspecialidadInstancia = null;

    // Función para actualizar fecha y hora
    function actualizarReloj() {
        const ahora = new Date();
        const opcionesFecha = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const opcionesHora = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
        
        document.getElementById('fecha').textContent = ahora.toLocaleDateString('es-ES', opcionesFecha);
        document.getElementById('hora').textContent = ahora.toLocaleTimeString('es-ES', opcionesHora);
    }
    
    // Actualizar cada segundo
    setInterval(actualizarReloj, 1000);
    actualizarReloj();

    // Escuchar TODOS los pacientes (espera y atendidos) para estadísticas
    const q = query(collection(db, "pacientes"));

    onSnapshot(q, (snapshot) => {
        let totalEspera = 0;
        let criticos = 0;
        let atendidos = 0;
        
        // Contadores para gráficas
        let conteoNiveles = [0, 0, 0, 0, 0]; // Niveles 1 al 5
        let conteoEspecialidad = {};

        snapshot.forEach(doc => {
            const data = doc.data();
            // Estado real en espera
            const enEspera = ["espera", "pendiente", "triage", "registrado"];
            
            // Estado real atendido
            const esAtendido = ["atendido", "finalizado", "alta"];
            
            // Normalizamos estado
            const estado = (data.estado || "").toLowerCase().trim();
            
            if (esAtendido.includes(estado)) {
                atendidos++;
            } 
            else if (enEspera.includes(estado)) {
                totalEspera++;
                
                if (data.nivel_prioridad <= 2) criticos++;
                
                if(data.nivel_prioridad >= 1 && data.nivel_prioridad <= 5) {
                    conteoNiveles[data.nivel_prioridad - 1]++;
                }
                
                const esp = data.especialidad || "General";
                conteoEspecialidad[esp] = (conteoEspecialidad[esp] || 0) + 1;
            }
        });

        // Actualizar Tarjetas
        document.getElementById('total-pacientes').innerText = totalEspera;
        document.getElementById('pacientes-detalle').innerText = `En espera: ${totalEspera}`;
        
        document.getElementById('total-criticos').innerText = criticos;
        document.getElementById('criticos-detalle').innerText = criticos > 0 ? "Requieren atención inmediata" : "Sin pacientes críticos";
        
        document.getElementById('total-atendidos').innerText = atendidos;
        document.getElementById('atendidos-detalle').innerText = `Desde inicio de jornada`;
        
        // Cálculo de saturación (Asumiendo capacidad de 20 pacientes)
        let porcentaje = Math.min(100, Math.round((totalEspera / 20) * 100));
        document.getElementById('saturacion').innerText = porcentaje + "%";
        
        // Actualizar badge de saturación
        const badge = document.getElementById('saturacion-badge');
        badge.className = "saturacion-badge mt-1";
        
        if (porcentaje < 50) {
            badge.classList.add("saturacion-bajo");
            badge.textContent = "Baja";
        } else if (porcentaje < 80) {
            badge.classList.add("saturacion-medio");
            badge.textContent = "Media";
        } else {
            badge.classList.add("saturacion-alto");
            badge.textContent = "Alta";
        }

        // Actualizar Gráficas
        actualizarGraficaBarras(conteoNiveles);
        actualizarGraficaDona(conteoEspecialidad);
        
        // Actualizar tabla resumen
        actualizarTablaResumen(conteoNiveles, totalEspera);
    });

    function actualizarGraficaBarras(data) {
        const ctx = document.getElementById('chartNiveles').getContext('2d');
        
        if (chartNivelesInstancia) chartNivelesInstancia.destroy();

        chartNivelesInstancia = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Nivel 1', 'Nivel 2', 'Nivel 3', 'Nivel 4', 'Nivel 5'],
                datasets: [{
                    label: 'Pacientes en Espera',
                    data: data,
                    backgroundColor: ['#dc3545', '#fd7e14', '#0dcaf0', '#198754', '#0d6efd'],
                    borderColor: ['#b02a37', '#ca6702', '#0aa2c0', '#146c43', '#0a58ca'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += context.parsed.y + ' pacientes';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return value + (value === 1 ? ' paciente' : ' pacientes');
                            }
                        },
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    function actualizarGraficaDona(dataObj) {
        const ctx = document.getElementById('chartEspecialidad').getContext('2d');
        const labels = Object.keys(dataObj);
        const data = Object.values(dataObj);
        
        // Colores para las especialidades
        const colores = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#5a5c69'];

        if (chartEspecialidadInstancia) chartEspecialidadInstancia.destroy();

        chartEspecialidadInstancia = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colores.slice(0, labels.length),
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} pacientes (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '60%'
            }
        });
    }
    
    function actualizarTablaResumen(conteoNiveles, total) {
        const nombresNiveles = [
            "Resucitación (Crítico)",
            "Emergencia (Alto)",
            "Urgencia (Medio)",
            "Menor (Bajo)",
            "No Urgente (Muy Bajo)"
        ];
        
        const coloresBadge = ["danger", "warning", "info", "success", "primary"];
        
        let html = "";
        
        for (let i = 0; i < conteoNiveles.length; i++) {
            const porcentaje = total > 0 ? Math.round((conteoNiveles[i] / total) * 100) : 0;
            
            html += `
            <tr>
                <td class="align-middle">
                    <span class="badge bg-${coloresBadge[i]} p-2">N${i+1}</span>
                </td>
                <td class="align-middle">${nombresNiveles[i]}</td>
                <td class="align-middle">
                    <div class="d-flex align-items-center">
                        <div class="fw-bold me-2">${conteoNiveles[i]}</div>
                        <div class="progress flex-grow-1" style="height: 8px;">
                            <div class="progress-bar bg-${coloresBadge[i]}" role="progressbar" style="width: ${porcentaje}%"></div>
                        </div>
                    </div>
                </td>
                <td class="align-middle">${calcularTiempoPromedio(i+1)} min</td>
                <td class="align-middle">
                    <span class="badge ${conteoNiveles[i] > 0 ? 'bg-warning' : 'bg-success'}">
                        ${conteoNiveles[i] > 0 ? 'En espera' : 'Sin pacientes'}
                    </span>
                </td>
            </tr>
            `;
        }
        
        document.getElementById('tabla-resumen').innerHTML = html;
    }
    
    // Función simulada para calcular tiempo promedio (en un sistema real vendría de la BD)
    function calcularTiempoPromedio(nivel) {
        // Valores de ejemplo según nivel de prioridad
        const tiempos = [15, 30, 60, 90, 120];
        return tiempos[nivel-1] || 0;
    }
</script>

<script>
    // MODO OSCURO MEJORADO
    const body = document.body;
    const btn = document.getElementById("darkModeBtn");
    const iconBtn = btn.querySelector("i");

    // Función para aplicar el modo
    // En el script del modo oscuro, reemplaza la función aplicarModo por esta versión mejorada:
function aplicarModo(modo) {
    if (modo === "dark") {
        body.classList.add("dark-mode");
        body.classList.remove("light-mode");
        btn.innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
        document.documentElement.setAttribute('data-bs-theme', 'dark');
        
        // Forzar colores específicos para navbar en modo oscuro
        const navbar = document.getElementById('mainNav');
        if (navbar) {
            navbar.style.backgroundColor = '#212529';
        }
    } else {
        body.classList.add("light-mode");
        body.classList.remove("dark-mode");
        btn.innerHTML = '<i class="fas fa-moon"></i> Modo Oscuro';
        document.documentElement.setAttribute('data-bs-theme', 'light');
        
        // Forzar colores específicos para navbar en modo claro
        const navbar = document.getElementById('mainNav');
        if (navbar) {
            navbar.style.backgroundColor = '#0d6efd';
        }
    }
}

    // Leer preferencia guardada
    const modoGuardado = localStorage.getItem("modo") || "light";
    aplicarModo(modoGuardado);

    // Cambiar modo al hacer click
    btn.addEventListener("click", () => {
        const nuevoModo = body.classList.contains("dark-mode") ? "light" : "dark";
        localStorage.setItem("modo", nuevoModo);
        aplicarModo(nuevoModo);
    });

    // Sincronizar en otras pestañas abiertas
    window.addEventListener("storage", (e) => {
        if (e.key === "modo") aplicarModo(e.newValue);
    });

    // Efecto de animación al cargar
    document.addEventListener('DOMContentLoaded', function() {
        // Añadir clase de animación a los elementos
        const cards = document.querySelectorAll('.card');
        cards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>