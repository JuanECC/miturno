<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recepci√≥n e Informes</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="./rsc/css_recepcion.css">
</head>
<body>

<!-- ‚ñà‚ñà‚ñà MEN√ö DE NAVEGACI√ìN ‚ñà‚ñà‚ñà -->
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="recepcion.html">üè• Recepci√≥n</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu" aria-expanded="false">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="menu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="pantalla.html">üñ•Ô∏è Pantalla de turnos</a></li>
        <li class="nav-item"><a class="nav-link" href="doctor.html">üë®‚Äç‚öïÔ∏è Doctor</a></li>
        <li class="nav-item"><a class="nav-link" href="admin.html">‚öôÔ∏è Administraci√≥n</a></li>
        <li class="nav-item"><button id="darkModeBtn" class="btn btn-outline-dark ms-3">üåô</button></li>
      </ul>
    </div>
  </div>
</nav>
<!-- ‚ñà‚ñà‚ñà FIN DEL MEN√ö ‚ñà‚ñà‚ñà -->

<div class="container mt-4 mb-5 no-print">

  <!-- PESTA√ëAS -->
  <ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="pills-ingreso-tab" data-bs-toggle="pill" data-bs-target="#pills-ingreso" type="button">üìù Nuevo Ingreso</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="pills-informes-tab" data-bs-toggle="pill" data-bs-target="#pills-informes" type="button">üîç Informes Familiares</button>
    </li>
  </ul>

  <div class="tab-content" id="pills-tabContent">

    <!-- ‚ñ∏ NUEVO INGRESO -->
    <div class="tab-pane fade show active" id="pills-ingreso">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white text-center py-3"><h4 class="mb-0">ADMISI√ìN Y TRIAJE</h4></div>
        <div class="card-body p-4">
          <form id="triageForm">
            <!-- 1. IDENTIFICACI√ìN -->
            <h6 class="text-secondary border-bottom pb-2 mb-3">1. Identificaci√≥n</h6>
            <div class="row mb-3">
              <div class="col-md-5"><label class="fw-bold">Nombre</label><input type="text" id="nombre" class="form-control" required></div>
              <div class="col-md-2"><label class="fw-bold">Edad</label><input type="number" id="edad" class="form-control" required></div>
              <div class="col-md-5"><label class="fw-bold">Especialidad</label>
                <select id="especialidad" class="form-select">
                  <option value="Medicina General">Medicina General</option>
                  <option value="Traumatolog√≠a">Traumatolog√≠a</option>
                  <option value="Cardiolog√≠a">Cardiolog√≠a</option>
                  <option value="Pediatr√≠a">Pediatr√≠a</option>
                  <option value="Ginecolog√≠a">Ginecolog√≠a</option>
                </select>
              </div>
            </div>

            <!-- 2. SIGNOS VITALES -->
            <h6 class="text-primary border-bottom pb-2 mt-4 mb-3">2. Signos Vitales</h6>
            <div class="row g-2 bg-light p-3 rounded border mb-3">
              <div class="col-md-2"><span class="label-vital">T/A</span><input type="text" id="v_ta" class="form-control input-vital" placeholder="120/80"></div>
              <div class="col-md-2"><span class="label-vital">Temp</span><input type="number" id="v_temp" class="form-control input-vital" placeholder="36.5"></div>
              <div class="col-md-2"><span class="label-vital">F.C.</span><input type="number" id="v_fc" class="form-control input-vital" placeholder="80"></div>
              <div class="col-md-2"><span class="label-vital">SpO2</span><input type="number" id="v_spo2" class="form-control input-vital" placeholder="98"></div>
              <div class="col-md-2"><span class="label-vital">Glucosa</span><input type="number" id="v_glu" class="form-control input-vital"></div>
              <div class="col-md-2"><span class="label-vital">Peso</span><input type="number" id="v_peso" class="form-control input-vital"></div>
            </div>

            <div class="mb-3"><label class="fw-bold">Motivo</label><input type="text" id="motivo" class="form-control" required></div>

            <!-- 3. SIGNOS DE ALARMA -->
            <h6 class="text-danger border-bottom pb-2 mt-4 mb-2">3. Signos de Alarma</h6>
            <div class="row mb-3">
              <div class="col-md-4"><input type="checkbox" class="btn-check alarma-check" id="s1" value="Dificultad Respiratoria"><label class="btn btn-outline-secondary w-100" for="s1">Dificultad Respiratoria</label></div>
              <div class="col-md-4"><input type="checkbox" class="btn-check alarma-check" id="s2" value="Dolor Tor√°cico"><label class="btn btn-outline-secondary w-100" for="s2">Dolor Tor√°cico</label></div>
              <div class="col-md-4"><input type="checkbox" class="btn-check alarma-check" id="s3" value="Sangrado Activo"><label class="btn btn-outline-secondary w-100" for="s3">Sangrado Activo</label></div>
            </div>

            <div class="mb-3"><label>Antecedentes</label><textarea id="antecedentes" class="form-control" rows="2"></textarea></div>

            <!-- BOTONES DE NIVEL -->
            <hr class="my-4">
            <div class="d-grid gap-2">
              <button type="button" class="btn btn-nivel-1 priority-btn" onclick="registrarPaciente(1)">üî¥ NIVEL 1 - RESUCITACI√ìN</button>
              <button type="button" class="btn btn-nivel-2 priority-btn" onclick="registrarPaciente(2)">üü† NIVEL 2 - EMERGENCIA</button>
              <button type="button" class="btn btn-nivel-3 priority-btn" onclick="registrarPaciente(3)">üü° NIVEL 3 - URGENCIA</button>
              <button type="button" class="btn btn-nivel-4 priority-btn" onclick="registrarPaciente(4)">üü¢ NIVEL 4 - MENOR</button>
              <button type="button" class="btn btn-nivel-5 priority-btn" onclick="registrarPaciente(5)">üîµ NIVEL 5 - NO URGENTE</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- ‚ñ∏ INFORMES FAMILIARES -->
    <div class="tab-pane fade" id="pills-informes">
      <div class="card shadow">
        <div class="card-header bg-success text-white">
          <h4 class="mb-0">üîç B√∫squeda de Pacientes</h4>
        </div>
        <div class="card-body p-4">
          <h5 class="mb-3 text-center">Seleccione un paciente para ver su informaci√≥n</h5>
          
          <!-- Buscador con datalist/combobox -->
          <div class="row mb-4">
            <div class="col-md-10 offset-md-1">
              <div class="input-group">
                <span class="input-group-text">üë§</span>
                <input type="text" id="busquedaInforme" class="form-control" placeholder="Escriba para buscar o seleccione del listado..." list="listaPacientesDatalist" autocomplete="off">
                <datalist id="listaPacientesDatalist">
                  <!-- Se llenar√° autom√°ticamente con JavaScript -->
                </datalist>
                <button class="btn btn-success" type="button" onclick="buscarInforme()">
                  üîç Buscar
                </button>
                <button class="btn btn-outline-secondary" type="button" onclick="limpiarBusqueda()">
                  ‚úï Limpiar
                </button>
              </div>
              <div class="form-text mt-2">
                ‚ìò Escriba el nombre del paciente o seleccione uno del listado desplegable
              </div>
            </div>
          </div>

          <!-- Resultado de b√∫squeda -->
          <div id="resultadoBusqueda" class="mt-4">
            <div class="text-center text-muted">
              <div style="font-size: 4rem;">üë®‚Äç‚öïÔ∏è</div>
              <p class="mt-2">Seleccione un paciente para ver su informaci√≥n m√©dica</p>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- ‚ñ∏ HOJA DE ADMISION -->
<div id="formato-impresion" class="d-none d-print-block">
  <h2 class="text-center mb-4">üè• HOJA DE ADMISI√ìN</h2>
  
  <div class="card p-3 shadow-sm mb-3">
    <h5 class="fw-bold mb-2">Informaci√≥n del Paciente</h5>
    <div class="row">
      <div class="col-md-6"><p><strong>Nombre:</strong> <span id="print-nombre"></span></p></div>
      <div class="col-md-3"><p><strong>Edad:</strong> <span id="print-edad"></span></p></div>
      <div class="col-md-3"><p><strong>Especialidad:</strong> <span id="print-especialidad"></span></p></div>
    </div>
  </div>

  <div class="card p-3 shadow-sm mb-3 card-signos">
    <h5 class="fw-bold mb-2">Signos Vitales</h5>
    <div class="row">
      <div class="col-md-3"><p><strong>T/A:</strong> <span id="print-ta"></span></p></div>
      <div class="col-md-3"><p><strong>Temp:</strong> <span id="print-temp"></span></p></div>
      <div class="col-md-3"><p><strong>SpO2:</strong> <span id="print-spo2"></span></p></div>
      <div class="col-md-3"><p><strong>Peso:</strong> <span id="print-peso"></span></p></div>
    </div>
  </div>

  <div class="card p-3 shadow-sm mb-3">
    <h5 class="fw-bold mb-2">Motivo de Ingreso</h5>
    <p id="print-motivo"></p>
  </div>

  <div class="nivel-prioridad mb-3 text-center" id="print-nivel-div">
    NIVEL <span id="print-nivel"></span>
  </div>
</div>

<script type="module">
// Importar Firebase
import { db } from './firebase-config.js';
import { collection, addDoc, serverTimestamp, query, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Variables globales
let todosPacientes = [];

// --- FUNCION REGISTRAR PACIENTE (FIREBASE) ---
window.registrarPaciente = async function(nivel) {
    const nombre = document.getElementById('nombre').value.trim();
    const edad = document.getElementById('edad').value;
    const especialidad = document.getElementById('especialidad').value;
    const motivo = document.getElementById('motivo').value.trim();
    
    const vitales = {
        ta: document.getElementById('v_ta').value || '--',
        temp: document.getElementById('v_temp').value || '--',
        fc: document.getElementById('v_fc').value || '--',
        spo2: document.getElementById('v_spo2').value || '--',
        glu: document.getElementById('v_glu').value || '--',
        peso: document.getElementById('v_peso').value || '--'
    };
    
    let signosAlarma = [];
    document.querySelectorAll('.alarma-check:checked').forEach(c => signosAlarma.push(c.value));
    
    if(!nombre || !motivo) { 
        alert("Nombre y Motivo son obligatorios"); 
        return; 
    }

    try {
        // Crear documento en Firebase
        const nuevoPaciente = {
            nombre, 
            edad: parseInt(edad), 
            especialidad, 
            motivo, 
            vitales, 
            signosAlarma,
            nivel_prioridad: nivel, 
            estado: "espera",
            ubicacion_actual: "Sala de Espera",
            fecha_ingreso: serverTimestamp(),
            antecedentes: document.getElementById('antecedentes').value || '',
            atendido_por: "",
            hora_atencion: null,
            observaciones: ""
        };

        // Guardar en Firebase
        const docRef = await addDoc(collection(db, "pacientes"), nuevoPaciente);
        console.log("Paciente registrado con ID: ", docRef.id);

        // Llenar impresi√≥n
        document.getElementById('print-nombre').innerText = nombre;
        document.getElementById('print-edad').innerText = edad;
        document.getElementById('print-especialidad').innerText = especialidad;
        document.getElementById('print-ta').innerText = vitales.ta;
        document.getElementById('print-temp').innerText = vitales.temp;
        document.getElementById('print-spo2').innerText = vitales.spo2;
        document.getElementById('print-peso').innerText = vitales.peso;
        document.getElementById('print-motivo').innerText = motivo;
        document.getElementById('print-nivel').innerText = nivel;

        // Imprimir
        window.print();
        
        // Mostrar mensaje y limpiar formulario
        alert("‚úÖ Ingreso Exitoso - Paciente registrado en el sistema");
        document.getElementById('triageForm').reset();
        document.querySelectorAll('.alarma-check').forEach(c => c.checked = false);
        
        // Actualizar datalist
        await cargarListadoPacientesDatalist();
        
    } catch (error) {
        console.error("Error al registrar paciente: ", error);
        alert("‚ùå Error al registrar paciente. Verifica la conexi√≥n a internet.");
    }
}

// --- FUNCION BUSCAR PACIENTE (FIREBASE) ---
window.buscarInforme = async function() {
    const texto = document.getElementById('busquedaInforme').value.trim().toLowerCase();
    const div = document.getElementById('resultadoBusqueda');
    
    if(!texto) { 
        div.innerHTML = '<div class="alert alert-warning">Por favor, ingrese o seleccione un nombre de paciente.</div>';
        return; 
    }

    div.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div> Buscando pacientes...</div>';

    try {
        // Buscar en Firebase
        const q = query(collection(db, "pacientes"));
        const querySnapshot = await getDocs(q);
        
        const pacientesEncontrados = [];
        querySnapshot.forEach(doc => {
            const paciente = { id: doc.id, ...doc.data() };
            if (paciente.nombre && paciente.nombre.toLowerCase().includes(texto)) {
                pacientesEncontrados.push(paciente);
            }
        });

        if(pacientesEncontrados.length === 0) {
            div.innerHTML = '<div class="alert alert-warning">No se encontr√≥ al paciente. Verifique el nombre e intente nuevamente.</div>';
            return;
        }

        // Mostrar resultados
        let html = '';
        
        pacientesEncontrados.forEach(paciente => {
            // Determinar color seg√∫n nivel
            const borderColor = getBorderColorByNivel(paciente.nivel_prioridad);
            const bgColor = getBgColorByNivel(paciente.nivel_prioridad);
            
            // Determinar icono y texto seg√∫n estado
            let icono = "üè•";
            let textoEstado = paciente.ubicacion_actual || "Sala de Espera";
            
            if(paciente.estado === 'espera') { 
                icono = "‚è≥"; 
                textoEstado = "En espera";
            }
            if(paciente.ubicacion_actual === 'ALTA') {
                icono = "‚úÖ";
                textoEstado = "Dado de alta";
            }
            if(paciente.ubicacion_actual === 'CIRUGIA') {
                icono = "üî™";
                textoEstado = "En cirug√≠a";
            }
            if(paciente.ubicacion_actual === 'ATENDIDO') {
                icono = "üë®‚Äç‚öïÔ∏è";
                textoEstado = "En consulta";
            }

            // Formatear fecha
            let fechaStr = '--';
            if(paciente.fecha_ingreso && paciente.fecha_ingreso.seconds) {
                const fecha = new Date(paciente.fecha_ingreso.seconds * 1000);
                fechaStr = fecha.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            html += `
            <div class="card mb-3 shadow-sm" style="border-left: 5px solid ${borderColor}; background-color: ${bgColor};">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3 class="card-title">${paciente.nombre}</h3>
                            <p class="text-muted mb-1">${paciente.edad} a√±os | ${paciente.especialidad}</p>
                            <p class="mb-1"><strong>Fecha de ingreso:</strong> ${fechaStr}</p>
                        </div>
                        <span class="fs-1">${icono}</span>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="${getTextColorByNivel(paciente.nivel_prioridad)}">${textoEstado}</h5>
                            <small class="text-muted">Estatus actual</small>
                            <p class="mt-2"><strong>Nivel de prioridad:</strong> 
                                <span class="badge ${getBadgeClassByNivel(paciente.nivel_prioridad)}">Nivel ${paciente.nivel_prioridad}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Motivo de consulta:</strong> ${paciente.motivo}</p>
                            <div class="bg-light p-2 rounded small">
                                <strong>Signos vitales:</strong><br>
                                T/A: ${paciente.vitales?.ta || '--'} | Temp: ${paciente.vitales?.temp || '--'}¬∞C<br>
                                SpO2: ${paciente.vitales?.spo2 || '--'}% | Peso: ${paciente.vitales?.peso || '--'} kg
                            </div>
                        </div>
                    </div>
                    ${paciente.signosAlarma && paciente.signosAlarma.length > 0 ? 
                        `<div class="mt-2">
                            <strong>Signos de alarma:</strong>
                            <span class="badge bg-danger ms-1">${paciente.signosAlarma.join('</span> <span class="badge bg-danger ms-1">')}</span>
                        </div>` : ''}
                    ${paciente.antecedentes ? 
                        `<div class="mt-2">
                            <strong>Antecedentes:</strong>
                            <p class="mb-0">${paciente.antecedentes}</p>
                        </div>` : ''}
                </div>
            </div>
            `;
        });

        div.innerHTML = html;
        
    } catch (error) {
        console.error("Error al buscar pacientes: ", error);
        div.innerHTML = '<div class="alert alert-danger">Error al buscar pacientes. Verifica la conexi√≥n a internet.</div>';
    }
}

// --- FUNCION CARGAR LISTADO PARA DATALIST (FIREBASE) ---
async function cargarListadoPacientesDatalist() {
    const datalist = document.getElementById('listaPacientesDatalist');
    
    try {
        // Cargar pacientes de Firebase
        const q = query(collection(db, "pacientes"));
        const querySnapshot = await getDocs(q);
        
        // Limpiar datalist
        datalist.innerHTML = '';
        
        // Guardar todos los pacientes
        todosPacientes = [];
        const nombresUnicos = new Set();
        
        querySnapshot.forEach(doc => {
            const paciente = { id: doc.id, ...doc.data() };
            todosPacientes.push(paciente);
            
            // Agregar opci√≥n al datalist si el nombre no est√° repetido
            if(!nombresUnicos.has(paciente.nombre)) {
                const option = document.createElement('option');
                option.value = paciente.nombre;
                option.textContent = `${paciente.nombre} (${paciente.edad} a√±os) - ${paciente.especialidad}`;
                datalist.appendChild(option);
                nombresUnicos.add(paciente.nombre);
            }
        });
        
        // Agregar event listener para cuando se seleccione del datalist
        document.getElementById('busquedaInforme').addEventListener('input', function(e) {
            const valorSeleccionado = e.target.value;
            // Si el valor coincide con una opci√≥n del datalist, buscar autom√°ticamente
            const opciones = Array.from(datalist.options);
            const existeOpcion = opciones.some(opcion => opcion.value === valorSeleccionado);
            
            if(existeOpcion) {
                // Peque√±o retraso para que el usuario vea la selecci√≥n
                setTimeout(() => buscarInforme(), 300);
            }
        });
        
    } catch (error) {
        console.error("Error al cargar listado de pacientes: ", error);
        // Fallback a localStorage si Firebase falla
        cargarListadoLocalStorage();
    }
}

// --- FUNCI√ìN DE FALLBACK (localStorage) ---
function cargarListadoLocalStorage() {
    const datalist = document.getElementById('listaPacientesDatalist');
    const pacientesLocal = JSON.parse(localStorage.getItem('pacientes')) || [];
    
    datalist.innerHTML = '';
    const nombresUnicos = new Set();
    
    pacientesLocal.forEach(paciente => {
        if(!nombresUnicos.has(paciente.nombre)) {
            const option = document.createElement('option');
            option.value = paciente.nombre;
            option.textContent = `${paciente.nombre} (${paciente.edad} a√±os) - ${paciente.especialidad}`;
            datalist.appendChild(option);
            nombresUnicos.add(paciente.nombre);
        }
    });
}

// --- FUNCION LIMPIAR B√öSQUEDA ---
window.limpiarBusqueda = function() {
    document.getElementById('busquedaInforme').value = '';
    document.getElementById('resultadoBusqueda').innerHTML = `
        <div class="text-center text-muted">
            <div style="font-size: 4rem;">üë®‚Äç‚öïÔ∏è</div>
            <p class="mt-2">Seleccione un paciente para ver su informaci√≥n m√©dica</p>
        </div>
    `;
}

// --- FUNCIONES AUXILIARES PARA COLORES ---
function getBorderColorByNivel(nivel) {
    switch(parseInt(nivel)) {
        case 1: return '#dc3545'; // Rojo
        case 2: return '#fd7e14'; // Naranja
        case 3: return '#ffc107'; // Amarillo
        case 4: return '#28a745'; // Verde
        case 5: return '#007bff'; // Azul
        default: return '#6c757d'; // Gris
    }
}

function getBgColorByNivel(nivel) {
    switch(parseInt(nivel)) {
        case 1: return 'rgba(220, 53, 69, 0.05)'; // Rojo muy claro
        case 2: return 'rgba(253, 126, 20, 0.05)'; // Naranja muy claro
        case 3: return 'rgba(255, 193, 7, 0.05)'; // Amarillo muy claro
        case 4: return 'rgba(40, 167, 69, 0.05)'; // Verde muy claro
        case 5: return 'rgba(0, 123, 255, 0.05)'; // Azul muy claro
        default: return 'rgba(108, 117, 125, 0.05)'; // Gris muy claro
    }
}

function getTextColorByNivel(nivel) {
    switch(parseInt(nivel)) {
        case 1: return 'text-danger';
        case 2: return 'text-warning';
        case 3: return 'text-info';
        case 4: return 'text-success';
        case 5: return 'text-primary';
        default: return 'text-secondary';
    }
}

function getBadgeClassByNivel(nivel) {
    switch(parseInt(nivel)) {
        case 1: return 'bg-danger';
        case 2: return 'bg-warning text-dark';
        case 3: return 'bg-info';
        case 4: return 'bg-success';
        case 5: return 'bg-primary';
        default: return 'bg-secondary';
    }
}

// --- INICIALIZAR ---
document.addEventListener('DOMContentLoaded', async function() {
    // Cargar listado de pacientes
    await cargarListadoPacientesDatalist();
    
    // Event listener para la tecla Enter en el buscador
    document.getElementById('busquedaInforme').addEventListener('keypress', function(e) {
        if(e.key === 'Enter') {
            e.preventDefault();
            buscarInforme();
        }
    });
});
</script>

<!-- ============================
     MODO OSCURO
============================ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const body = document.body;
  const btn = document.getElementById("darkModeBtn");

  function aplicarModo(modo){
      if(modo === "dark"){
          body.classList.add("dark-mode"); 
          body.classList.remove("light-mode"); 
          btn.textContent = "üåô";
      } else {
          body.classList.add("light-mode"); 
          body.classList.remove("dark-mode"); 
          btn.textContent = "‚òÄÔ∏è";
      }
  }

  const modoGuardado = localStorage.getItem("modo") || "light";
  aplicarModo(modoGuardado);

  btn.addEventListener("click", function(){
      const nuevoModo = body.classList.contains("dark-mode") ? "light" : "dark";
      localStorage.setItem("modo", nuevoModo);
      aplicarModo(nuevoModo);
  });

  window.addEventListener("storage", function(e){ 
      if(e.key === "modo") aplicarModo(e.newValue); 
  });
</script>

</body>
</html>